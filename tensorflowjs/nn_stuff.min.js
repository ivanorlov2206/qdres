var canvases=[];const NAME_LEN=15;var models={};function make_random_name(){for(var a="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890",e=a.length,t="",r=0;r<NAME_LEN;r++)t+=a.charAt(Math.floor(Math.random()*e));return t}function create_canv(a,e){let t=document.createElement("canvas");return t.width=a,t.height=e,t.id=make_random_name(),t.hidden=!0,canvases.push(t),document.body.appendChild(t),t}function find_contours(a){for(var e=a.getContext("2d"),t=a.width,r=a.height,n=t,o=r,c=0,d=0,s=0;s<r;s++)for(var i=0;i<t;i++){e.getImageData(i,s,1,1).data[0]>0&&(i<n&&(n=i),i>c&&(c=i),s<o&&(o=s),s>d&&(d=s))}return[n,o,c,d]}function crop_and_center_image(a,e){let t=a.width,r=a.height;var n,o;t>r?(o=e/t*r,n=e,console.log(n,o)):(n=e/r*t,o=e);var c=create_canv(n,o).getContext("2d");c.drawImage(a,0,0,n,o);var d=(e-o)/2,s=(e-n)/2,i=create_canv(e,e),m=i.getContext("2d");m.fillStyle="black",m.fillRect(0,0,e,e);for(var l=0;l<e;l++)for(var v=0;v<e;v++)if(l>=s&&l<s+n&&v>=d&&v<d+o){var g=c.getImageData(l-s,v-d,1,1);0!=g.data[0]&&m.putImageData(g,l,v)}return i}async function predict(a,e){var t;models[e]?t=models[e]:(t=await tf.loadLayersModel("http://127.0.0.1:8000/models/"+e+"/model.json"),models[e]=t);var r=process_image(a,28);let n=tf.tensor2d(r);n=n.reshape([-1,28,28,1]);let o=t.predict(n);return console.log(o),Array.from(o.dataSync())[0]}function image_to_array(a,e){for(var t=a.getContext("2d"),r=[],n=0;n<e;n++){for(var o=[],c=0;c<e;c++){t.getImageData(c,n,1,1).data[0]>0?o.push(255):o.push(0)}r.push(o)}return r}function process_image(a,e){let t=find_contours(a);var r=create_canv(t[2]-t[0],t[3]-t[1]),n=t[0],o=t[1],c=t[2]-t[0],d=t[3]-t[1];return r.getContext("2d").drawImage(a,n,o,c+n,d+o,0,0,c+n,d+o),image_to_array(crop_and_center_image(r,e),e)}function clear_canvases(){for(var a=0;a<canvases.length;a++)document.body.removeChild(canvases[a]);canvases=[]}
